# =============================================================================
# HexDrop External Secret
# =============================================================================
# Syncs secrets from AWS Secrets Manager to Kubernetes Secrets
# Requires: External Secrets Operator installed in the cluster
#
# Installation:
#   helm repo add external-secrets https://charts.external-secrets.io
#   helm install external-secrets external-secrets/external-secrets \
#     -n external-secrets --create-namespace

---
# ClusterSecretStore - Connects to AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
spec:
  provider:
    aws:
      service: SecretsManager
      region: ${AWS_REGION}  # Replace with your AWS region
      auth:
        # Uses IRSA (IAM Roles for Service Accounts) - recommended for EKS
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

---
# ExternalSecret - Fetches HexDrop secrets from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: hexdrop-secrets
  namespace: hexdrop
  labels:
    app.kubernetes.io/name: hexdrop
spec:
  refreshInterval: 1h  # How often to sync secrets
  
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  
  target:
    name: hexdrop-secrets
    creationPolicy: Owner
  
  # Map AWS Secrets Manager keys to Kubernetes secret keys
  data:
    # Database connection string
    - secretKey: DATABASE_URL
      remoteRef:
        key: hexdrop/production  # AWS Secrets Manager secret name
        property: DATABASE_URL   # JSON key within the secret
    
    # AWS credentials for S3 access
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: hexdrop/production
        property: AWS_ACCESS_KEY_ID
    
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: hexdrop/production
        property: AWS_SECRET_ACCESS_KEY
    
    - secretKey: AWS_REGION
      remoteRef:
        key: hexdrop/production
        property: AWS_REGION
    
    - secretKey: AWS_S3_BUCKET
      remoteRef:
        key: hexdrop/production
        property: AWS_S3_BUCKET

---
# Alternative: Simple Kubernetes Secret (for initial testing without External Secrets Operator)
# WARNING: Do not commit actual secret values to git!
# This is a template - replace values with base64 encoded secrets or use kubectl create secret
#
# apiVersion: v1
# kind: Secret
# metadata:
#   name: hexdrop-secrets
#   namespace: hexdrop
# type: Opaque
# stringData:
#   DATABASE_URL: "postgresql://user:password@host:5432/hexdrop"
#   AWS_ACCESS_KEY_ID: "your-access-key"
#   AWS_SECRET_ACCESS_KEY: "your-secret-key"
#   AWS_REGION: "us-east-1"
#   AWS_S3_BUCKET: "your-bucket-name"
